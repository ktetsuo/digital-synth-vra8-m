<!DOCTYPE html>
<head>
<meta charset="utf-8">
<title>VRA8-M CTRL</title>
<style>
* {
  -webkit-user-select: none;
}
td {
  text-align: left;
}
td.key {
  text-align: center;
  width: 48px;
  height: 64px;
  border: 2px solid #999;
}
td.keyh {
  text-align: center;
  width: 20px;
  height: 64px;
  border: 2px solid #999;
}
</style>
<script>
const MIDI_CH        = 0;
const NOTE_OFF       = 0x80;
const NOTE_ON        = 0x90;
const CONTROL_CHANGE = 0xB0;

const LFO_RATE_EG_AMT   = 16;
const VCO_MIX_EG_AMT    = 17;
const VCO_COLOR_EG_AMT  = 18;
const VCO_COLOR_LFO_AMT = 19;
const VCF_CUTOFF_EG_AMT = 20;
const EG_ATTACK         = 21;
const EG_DECAY_RELEASE  = 22;
const EG_SUSTAIN        = 23;
const LFO_RATE          = 24;
const VCO_MIX           = 25;
const VCO_PULSE_WIDTH   = 26;
const VCO_SAW_SHIFT     = 27;
const VCF_CUTOFF        = 28;
const VCF_RESONANCE     = 29;
const VCA_GAIN          = 30;
const PORTAMENTO        = 31;
const ALL_NOTES_OFF     = 123;

const CONTROLLERS_FIRST = 16;
const CONTROLLERS_LAST  = 31;
</script>
<script>
var transpose = 0;

window.onload = function() {
  if (navigator.requestMIDIAccess) {
    navigator.requestMIDIAccess().then(onMIDISuccess, onMIDIFailure);
  } else {
    console.log("No MIDI support present in your browser.");
  }

  var result = restoreControllers();
  if (!result) {
    onChangeTranspose(0);
    preset(0);
  }

  if (midiOutput) {
    midiOutput.send([(CONTROL_CHANGE | MIDI_CH), ALL_NOTES_OFF, 0]);
  }
};

function restoreControllers() {
  var value;
  for (var i = CONTROLLERS_FIRST; i <= CONTROLLERS_LAST; i++) {
    value = localStorage.getItem("keyCC" + String(i));
    if (!value) {
      return false;
    }
    onChangeControlChange(i, value);
  }

  value = localStorage.getItem("keyTranspose");
  if (!value) {
    return false;
  }
  onChangeTranspose(value);

  return true;
}

function onChangeTranspose(value) {
  document.getElementById("inputTranspose").value = parseInt(value);
  document.getElementById("spanTranspose").innerHTML = value;
  localStorage.setItem("keyTranspose", value);
  transpose = parseInt(value);
}
</script>
<script>
var midi        = null;
var midiInputs  = null;
var midiInput   = null;
var midiOutputs = null;
var midiOutput  = null;

function onMIDIMessage(event) {
  if (midiOutput) {
    midiOutput.send(event.data);
  }
}

function onMIDISuccess(midiAccess) {
  console.log("MIDI ready!");
  midi = midiAccess;

  var inputIterator = midi.inputs.values();
  midiInputs = [];
  for (var o = inputIterator.next(); !o.done; o = inputIterator.next()) {
    midiInputs.push(o.value)
  }
  var outputIterator = midi.outputs.values();
  midiOutputs = [];
  for (var o = outputIterator.next(); !o.done; o = outputIterator.next()) {
    midiOutputs.push(o.value)
  }

  var selectInputPort = document.getElementById("selectInputPort");
  for (var i = 0; i < midiInputs.length; i++) {
    selectInputPort.appendChild(new Option(midiInputs[i].name))
  }
  onChangeInputPort();
  var selectOutputPort = document.getElementById("selectOutputPort");
  for (var i = 0; i < midiOutputs.length; i++) {
    selectOutputPort.appendChild(new Option(midiOutputs[i].name))
  }
  onChangeOutputPort();
}

function onMIDIFailure(msg) {
  console.log("Failed to get MIDI access - " + msg);
}

function onChangeInputPort(){
  var selectInputPort = document.getElementById("selectInputPort");
  midiInput = midiInputs[selectInputPort.selectedIndex];
  if (midiInput) {
    midiInput.onmidimessage = onMIDIMessage;
  }
}

function onChangeOutputPort() {
  var selectOutputPort = document.getElementById("selectOutputPort");
  midiOutput = midiOutputs[selectOutputPort.selectedIndex];
  if (midiOutput) {
    var result = restoreControllers();
    if (!result) {
      onChangeTranspose(0);
      preset(0);
    }
  }
}

function onChangeControlChange(number, value) {
  document.getElementById("inputCC" + String(number)).value = parseInt(value);
  document.getElementById("spanCC" + String(number)).innerHTML = value;
  localStorage.setItem("keyCC" + String(number), value);
  if (midiOutput) {
    midiOutput.send([(CONTROL_CHANGE | MIDI_CH), number, parseInt(value)]);
  }
}

function preset(number) {
  var presetControllers = {};
  presetControllers[LFO_RATE         ] = [0  , 0  , 0  , 64 , 64 , 64 , 64 ];
  presetControllers[LFO_RATE_EG_AMT  ] = [64 , 64 , 64 , 0  , 0  , 0  , 0  ];
  presetControllers[VCO_MIX          ] = [0  , 0  , 0  , 127, 0  , 0  , 0  ];
  presetControllers[VCO_MIX_EG_AMT   ] = [64 , 64 , 64 , 0  , 0  , 0  , 0  ];
  presetControllers[VCO_PULSE_WIDTH  ] = [0  , 0  , 0  , 0  , 0  , 64 , 96 ];
  presetControllers[VCO_SAW_SHIFT    ] = [64 , 64 , 64 , 0  , 0  , 0  , 0  ];
  presetControllers[VCO_COLOR_EG_AMT ] = [64 , 64 , 64 , 0  , 0  , 0  , 0  ];
  presetControllers[VCO_COLOR_LFO_AMT] = [64 , 64 , 64 , 64 , 64 , 64 , 64 ];
  presetControllers[VCF_CUTOFF       ] = [32 , 32 , 32 , 127, 127, 127, 127];
  presetControllers[VCF_CUTOFF_EG_AMT] = [127, 127, 127, 0  , 0  , 0  , 0  ];
  presetControllers[VCF_RESONANCE    ] = [127, 127, 127, 0  , 0  , 0  , 0  ];
  presetControllers[VCA_GAIN         ] = [127, 127, 127, 127, 127, 127, 127];
  presetControllers[EG_ATTACK        ] = [32 , 96 , 32 , 0  , 0  , 0  , 0  ];
  presetControllers[EG_DECAY_RELEASE ] = [96 , 96 , 96 , 0  , 0  , 0  , 0  ];
  presetControllers[EG_SUSTAIN       ] = [96 , 96 , 0  , 127, 127, 127, 127];
  presetControllers[PORTAMENTO       ] = [64 , 64 , 64 , 0  , 0  , 0  , 0  ];

  for (var i = CONTROLLERS_FIRST; i <= CONTROLLERS_LAST; i++) {
    onChangeControlChange(i, presetControllers[i][number]);
  }
}

function setRandomly() {
  for (var i = CONTROLLERS_FIRST; i <= CONTROLLERS_LAST; i++) {
    if (i == VCA_GAIN) {
      onChangeControlChange(i, 96);
    } else {
      onChangeControlChange(i, rand());
    }
  }
}

function rand() {
  return Math.floor(Math.random() * 128);
}

function loadControllers(number) {
  var value;
  for (var i = CONTROLLERS_FIRST; i <= CONTROLLERS_LAST; i++) {
    value = localStorage.getItem("keyMemory" + String(number) + "CC" + String(i));
    if (!value) {
      return;
    }
    onChangeControlChange(i, value);
  }
}

function saveControllers(number) {
  var r = confirm("Save current parameters to Memory #" + String(number) + "?");
  if (r == false) {
    return;
  }

  for (var i = CONTROLLERS_FIRST; i <= CONTROLLERS_LAST; i++) {
    var value = document.getElementById("inputCC" + String(i)).value;
    localStorage.setItem("keyMemory" + String(number) + "CC" + String(i), value);
  }
}

function noteOn(noteNumber) {
  if (midiOutput) {
    midiOutput.send([(NOTE_ON | MIDI_CH), noteNumber + transpose, 64]);
  }
}

function noteOff(noteNumber) {
  if (midiOutput) {
    midiOutput.send([(NOTE_OFF | MIDI_CH), noteNumber + transpose, 0]);
  }
}
</script>
</head>
<body>
<h1>VRA8-M CTRL 0.0.0</h1>

<p>Digital Synth VRA8-M Controller<p>

<h2>MIDI Settings</h2>

<table>
<tr>
<td>MIDI IN</td>
<td colspan="2"><select id="selectInputPort" size="1" onchange="onChangeInputPort()"></select></td>
</tr>
<tr>
<td>MIDI OUT</td>
<td colspan="2"><select id="selectOutputPort" size="1" onchange="onChangeOutputPort()"></select></td>
</tr>
</table>

<p>We recommend Google Chrome, which implements Web MIDI API</p>

<h2>Controllers</h2>

<table>
<tr><td>LFO<br>Rate           </td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
    <td>VCO<br>Mix (Pulse/Saw)</td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
    <td>VCO<br>Pulse Width    </td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td>
    <td>VCO<br>Saw Shift      </td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
<tr><td><input id="inputCC24" type="range" min="0" max="127" step="1" oninput="onChangeControlChange(24, value)"></td><td><span id="spanCC24">-1</span></td>
    <td><input id="inputCC25" type="range" min="0" max="127" step="1" oninput="onChangeControlChange(25, value)"></td><td><span id="spanCC25">-1</span></td>
    <td><input id="inputCC26" type="range" min="0" max="127" step="1" oninput="onChangeControlChange(26, value)"></td><td><span id="spanCC26">-1</span></td>
    <td><input id="inputCC27" type="range" min="0" max="127" step="1" oninput="onChangeControlChange(27, value)"></td><td><span id="spanCC27">-1</span></td></tr>
<tr><td>&nbsp;</td></tr>
<tr><td>LFO<br>Rate EG Amt    </td><td></td>
    <td>VCO<br>Mix EG Amt     </td><td></td>
    <td>VCO<br>Color EG Amt   </td><td></td>
    <td>VCO<br>Color LFO Amt  </td><td></td></tr>
<tr><td><input id="inputCC16" type="range" min="0" max="127" step="1" oninput="onChangeControlChange(16, value)"></td><td><span id="spanCC16">-1</span></td>
    <td><input id="inputCC17" type="range" min="0" max="127" step="1" oninput="onChangeControlChange(17, value)"></td><td><span id="spanCC17">-1</span></td>
    <td><input id="inputCC18" type="range" min="0" max="127" step="1" oninput="onChangeControlChange(18, value)"></td><td><span id="spanCC18">-1</span></td>
    <td><input id="inputCC19" type="range" min="0" max="127" step="1" oninput="onChangeControlChange(19, value)"></td><td><span id="spanCC19">-1</span></td></tr>
<tr><td>&nbsp;</td></tr>
<tr><td>VCF<br>Cutoff         </td><td></td>
    <td>VCF<br>Resonance      </td><td></td>
    <td>VCA<br>Gain           </td><td></td>
    <td>MISC<br>Portamento    </td><td></td></tr>
<tr><td><input id="inputCC28" type="range" min="0" max="127" step="1" oninput="onChangeControlChange(28, value)"></td><td><span id="spanCC28">-1</span></td>
    <td><input id="inputCC29" type="range" min="0" max="127" step="1" oninput="onChangeControlChange(29, value)"></td><td><span id="spanCC29">-1</span></td>
    <td><input id="inputCC30" type="range" min="0" max="127" step="1" oninput="onChangeControlChange(30, value)"></td><td><span id="spanCC30">-1</span></td>
    <td><input id="inputCC31" type="range" min="0" max="127" step="1" oninput="onChangeControlChange(31, value)"></td><td><span id="spanCC31">-1</span></td></tr>
<tr><td>&nbsp;</td></tr>
<tr><td>VCF<br>Cutoff EG Amt  </td><td></td>
    <td>EG<br>Attack          </td><td></td>
    <td>EG<br>Decay/Release   </td><td></td>
    <td>EG<br>Sustain         </td><td></td></tr>
<tr><td><input id="inputCC20" type="range" min="0" max="127" step="1" oninput="onChangeControlChange(20, value)"></td><td><span id="spanCC20">-1</span></td>
    <td><input id="inputCC21" type="range" min="0" max="127" step="1" oninput="onChangeControlChange(21, value)"></td><td><span id="spanCC21">-1</span></td>
    <td><input id="inputCC22" type="range" min="0" max="127" step="1" oninput="onChangeControlChange(22, value)"></td><td><span id="spanCC22">-1</span></td>
    <td><input id="inputCC23" type="range" min="0" max="127" step="1" oninput="onChangeControlChange(23, value)"></td><td><span id="spanCC23">-1</span></td></tr>
<tr><td>&nbsp;</td></tr>
</table>

<p><input type="button" value="Preset Lead" onclick="preset(0)">
   <input type="button" value="Preset Pad"  onclick="preset(1)">
   <input type="button" value="Preset Bass" onclick="preset(2)">
   <input type="button" value="Saw"         onclick="preset(3)">
   <input type="button" value="Square"      onclick="preset(4)">
   <input type="button" value="Pulse 25%"   onclick="preset(5)">
   <input type="button" value="Pulse 12.5%" onclick="preset(6)">
   &nbsp;
   <input type="button" value="Random"       onclick="setRandomly()"></p>

<p><input type="button" value="Load #0" onclick="loadControllers(0)">
   <input type="button" value="Load #1" onclick="loadControllers(1)">
   <input type="button" value="Load #2" onclick="loadControllers(2)">
   <input type="button" value="Load #3" onclick="loadControllers(3)">
   <input type="button" value="Load #4" onclick="loadControllers(4)">
   &nbsp;
   <input type="button" value="Save #0" onclick="saveControllers(0)">
   <input type="button" value="Save #1" onclick="saveControllers(1)">
   <input type="button" value="Save #2" onclick="saveControllers(2)">
   <input type="button" value="Save #3" onclick="saveControllers(3)">
   <input type="button" value="Save #4" onclick="saveControllers(4)"></p>

<h2>Software Keyboard</h2>

<table>
<tr>
<td class="keyh"></td>
<td class="key" onmouseover="noteOn(49)" onmouseout="noteOff(49)">C#3</td>
<td class="key" onmouseover="noteOn(51)" onmouseout="noteOff(51)">D#3</td>
<td class="keyh"></td>
<td class="keyh"></td>
<td class="key" onmouseover="noteOn(54)" onmouseout="noteOff(54)">F#3</td>
<td class="key" onmouseover="noteOn(56)" onmouseout="noteOff(56)">G#3</td>
<td class="key" onmouseover="noteOn(58)" onmouseout="noteOff(58)">A#3</td>
<td class="keyh"></td>
<td class="keyh"></td>
<td class="key" onmouseover="noteOn(61)" onmouseout="noteOff(61)">C#4</td>
<td class="key" onmouseover="noteOn(63)" onmouseout="noteOff(63)">D#4</td>
<td class="keyh"></td>
<td class="keyh"></td>
<td class="key" onmouseover="noteOn(66)" onmouseout="noteOff(66)">F#4</td>
<td class="key" onmouseover="noteOn(68)" onmouseout="noteOff(68)">G#4</td>
<td class="key" onmouseover="noteOn(70)" onmouseout="noteOff(70)">A#4</td>
<td class="keyh"></td>
<td class="keyh"></td>
<td class="keyh"></td>
</tr>
</table>
<table>
<tr>
<td class="key" onmouseover="noteOn(48)" onmouseout="noteOff(48)">C3</td>
<td class="key" onmouseover="noteOn(50)" onmouseout="noteOff(50)">D3</td>
<td class="key" onmouseover="noteOn(52)" onmouseout="noteOff(52)">E3</td>
<td class="key" onmouseover="noteOn(53)" onmouseout="noteOff(53)">F3</td>
<td class="key" onmouseover="noteOn(55)" onmouseout="noteOff(55)">G3</td>
<td class="key" onmouseover="noteOn(57)" onmouseout="noteOff(57)">A3</td>
<td class="key" onmouseover="noteOn(59)" onmouseout="noteOff(59)">B3</td>
<td class="key" onmouseover="noteOn(60)" onmouseout="noteOff(60)">C4</td>
<td class="key" onmouseover="noteOn(62)" onmouseout="noteOff(62)">D4</td>
<td class="key" onmouseover="noteOn(64)" onmouseout="noteOff(64)">E4</td>
<td class="key" onmouseover="noteOn(65)" onmouseout="noteOff(65)">F4</td>
<td class="key" onmouseover="noteOn(67)" onmouseout="noteOff(67)">G4</td>
<td class="key" onmouseover="noteOn(69)" onmouseout="noteOff(69)">A4</td>
<td class="key" onmouseover="noteOn(71)" onmouseout="noteOff(71)">B4</td>
<td class="key" onmouseover="noteOn(72)" onmouseout="noteOff(72)">C5</td>
</tr>
</table>

<table>
<tr>
<td>Transpose</td>
<td><input id="inputTranspose" type="range" min="-12" max="24" step="12" onchange="onChangeTranspose(value)" ></td><td><span id="spanTranspose" >-1</span></td>
</tr>
</table>

<h2>About</h2>

<p>Made by ISGK Instruments (<a href="https://github.com/risgk/digital-synth-vra8-m">View on GitHub</a>)</p>

</body>
</html>
